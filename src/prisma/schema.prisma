// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  apiKeys       ApiKey[]
  integrations  Integration[]
  auditLogs     AuditLog[]
  webhooks      Webhook[]
  teamMembers   TeamMember[]
  notifications Notification[]
  sessions      Session[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN
  DEVELOPER
  USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

// Session Management
model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// API Key Management
model ApiKey {
  id          String       @id @default(cuid())
  userId      String
  name        String
  key         String       @unique
  status      ApiKeyStatus @default(ACTIVE)
  permissions Json         // Store permissions as JSON
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

// Integration Management
model Integration {
  id          String            @id @default(cuid())
  userId      String
  name        String
  provider    String
  category    String
  status      IntegrationStatus @default(INACTIVE)
  config      Json              // Store configuration as JSON
  credentials Json?             // Encrypted credentials
  syncFrequency String?
  lastSyncAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([provider])
  @@index([status])
  @@map("integrations")
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  SYNCING
}

// API Gateway Routes
model ApiRoute {
  id          String          @id @default(cuid())
  path        String
  method      HttpMethod
  description String?
  status      RouteStatus     @default(ACTIVE)
  rateLimit   Int?            // Requests per minute
  timeout     Int?            // Milliseconds
  retries     Int             @default(3)
  transform   Json?           // Request/response transformations
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  policies    RoutePolicy[]
  
  @@unique([path, method])
  @@index([status])
  @@map("api_routes")
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  OPTIONS
  HEAD
}

enum RouteStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

// Route Policies
model RoutePolicy {
  id          String       @id @default(cuid())
  routeId     String
  type        PolicyType
  config      Json
  priority    Int          @default(0)
  createdAt   DateTime     @default(now())
  
  route       ApiRoute     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  
  @@index([routeId])
  @@map("route_policies")
}

enum PolicyType {
  RATE_LIMIT
  AUTHENTICATION
  AUTHORIZATION
  TRANSFORMATION
  CORS
  CACHE
  VALIDATION
}

// Webhook Management
model Webhook {
  id          String        @id @default(cuid())
  userId      String
  url         String
  events      String[]      // Array of event types
  status      WebhookStatus @default(ACTIVE)
  secret      String?
  headers     Json?
  retryPolicy Json?
  lastTriggeredAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]
  
  @@index([userId])
  @@index([status])
  @@map("webhooks")
}

enum WebhookStatus {
  ACTIVE
  INACTIVE
  FAILED
}

model WebhookDelivery {
  id          String            @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  status      DeliveryStatus
  statusCode  Int?
  response    String?
  attempts    Int               @default(0)
  deliveredAt DateTime?
  createdAt   DateTime          @default(now())
  
  webhook     Webhook           @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([status])
  @@map("webhook_deliveries")
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

// Monitoring & Analytics
model ApiLog {
  id          String   @id @default(cuid())
  method      String
  path        String
  statusCode  Int
  duration    Int      // Milliseconds
  ipAddress   String?
  userAgent   String?
  requestBody Json?
  responseBody Json?
  errorMessage String?
  timestamp   DateTime @default(now())
  
  @@index([timestamp])
  @@index([statusCode])
  @@index([path])
  @@map("api_logs")
}

model Metric {
  id          String   @id @default(cuid())
  name        String
  value       Float
  unit        String?
  tags        Json?
  timestamp   DateTime @default(now())
  
  @@index([name])
  @@index([timestamp])
  @@map("metrics")
}

// Audit Logs
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  changes     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

// Team Management
model Team {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  plan        TeamPlan     @default(FREE)
  status      TeamStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  members     TeamMember[]
  
  @@map("teams")
}

enum TeamPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TeamStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model TeamMember {
  id          String     @id @default(cuid())
  teamId      String
  userId      String
  role        TeamRole   @default(MEMBER)
  joinedAt    DateTime   @default(now())
  
  team        Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// Notifications
model Notification {
  id          String             @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?
  read        Boolean            @default(false)
  createdAt   DateTime           @default(now())
  
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([read])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  ALERT
}

// Billing & Subscriptions
model Subscription {
  id              String             @id @default(cuid())
  teamId          String?
  plan            TeamPlan
  status          SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAt        DateTime?
  canceledAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// AI Assistant
model AiConversation {
  id          String        @id @default(cuid())
  userId      String?
  title       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  messages    AiMessage[]
  
  @@map("ai_conversations")
}

model AiMessage {
  id              String          @id @default(cuid())
  conversationId  String
  role            MessageRole
  content         String
  tokens          Int?
  createdAt       DateTime        @default(now())
  
  conversation    AiConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@map("ai_messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Rate Limiting
model RateLimit {
  id          String   @id @default(cuid())
  identifier  String   // IP, userId, or API key
  endpoint    String
  count       Int      @default(0)
  resetAt     DateTime
  createdAt   DateTime @default(now())
  
  @@unique([identifier, endpoint])
  @@index([resetAt])
  @@map("rate_limits")
}
